#!/bin/bash

set -x

SITE_DOMAIN='<%= @site_domain %>'

export HOME=/var/acme
export SITE_DOMAIN='<%= @site_domain %>'

cd /var/acme/acme.sh

chown -R  root:root /var/acme
chown -R  root:root /var/acme/acme.sh

./acme.sh --install

chown -R  root:root /var/acme/.acme.sh

cd /var/acme

export ACMEDNS_USERNAME='<%= @acme_dns_username %>'
export ACMEDNS_PASSWORD='<%= @acme_dns_password %>'
export ACMEDNS_SUBDOMAIN='<%= @acme_dns_subdomain %>'
# note that typo in the decryption of the base url appears not be an actual typo
export ACMEDNS_BASE_URL='<%= @acme_dns_base_url %>'

.acme.sh/acme.sh --set-default-ca --server letsencrypt
.acme.sh/acme.sh --register-account -m emrsysadmin@pih.org
.acme.sh/acme.sh --issue --dns dns_acmedns -d "$SITE_DOMAIN" --force
.acme.sh/acme.sh --install-cert --domain "$SITE_DOMAIN" --cert-file /etc/letsencrypt/live/"$SITE_DOMAIN"/cert.pem --key-file /etc/letsencrypt/live/"$SITE_DOMAIN"/privkey.pem --fullchain-file /etc/letsencrypt/live/"$SITE_DOMAIN"/fullchain.pem --ca-file /etc/letsencrypt/live/"$SITE_DOMAIN"/chain.pem --reloadcmd "sudo /usr/sbin/service apache2 restart" --force



# we rely on our own cron job to renew the certificate
.acme.sh/acme.sh --uninstall-cronjob --force
