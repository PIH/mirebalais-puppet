#!/bin/bash

#set -x 

backupDir="/home/percona/backups"
openmrsDB="openmrs"
mysqlDB="mysql"
perconaUser="percona"
perconaPassword="<%= @percona_password %>"
perconaLogs="/home/percona/logs"

#Create the necessary directories
createDirectories () {
	mkdir -p /home/percona
    mkdir -p ${backupDir}
    mkdir -p ${perconaLogs}
}

#Delete previous backup files
deletePreviousBackups () {
    rm -rf ${backupDir}/*
}

#Create Full Backup
createFullBackup () {
    innobackupex --user=${perconaUser}  --password=${perconaPassword} --no-timestamp --databases="${openmrsDB} ${mysqlDB}" ${backupDir}/${openmrsDB} &>> ${perconaLogs}/`date +%y%m%d%H%M%S`_perconafullbackup.log
}

#Preparing the backup will make its data consistent, and usable for a restore
prepareBackup() {
    innobackupex --apply-log ${backupDir}/${openmrsDB} &>> ${perconaLogs}/`date +%y%m%d%H%M%S`_perconapreparebackup.log
}

createDirectories
deletePreviousBackups
createFullBackup
prepareBackup
